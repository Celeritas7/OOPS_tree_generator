<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python OOP Structure Visualizer - v4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Left Panel */
        .input-panel {
            width: 400px;
            background: #fff;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .input-panel h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-name-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .project-name-input {
            flex: 1;
            padding: 8px 12px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            color: #2c3e50;
            font-weight: 600;
        }

        .project-name-input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* File Management Section */
        .file-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .file-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .file-section-header h3 {
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .file-actions {
            display: flex;
            gap: 6px;
        }

        .file-action-btn {
            padding: 5px 10px;
            font-size: 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-btn {
            background: #3498db;
            color: white;
        }

        .upload-btn:hover {
            background: #2980b9;
        }

        .new-file-btn {
            background: #27ae60;
            color: white;
        }

        .new-file-btn:hover {
            background: #219a52;
        }

        .clear-btn {
            background: #e74c3c;
            color: white;
        }

        .clear-btn:hover {
            background: #c0392b;
        }

        #fileUploadInput {
            display: none;
        }

        /* File List */
        .file-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background: #f0f0f0;
        }

        .file-item.active {
            background: #e8f4fc;
            border-left: 3px solid #3498db;
        }

        .file-item-name {
            flex: 1;
            font-size: 0.85rem;
            color: #333;
        }

        .file-item-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .file-item:hover .file-item-actions {
            opacity: 1;
        }

        .file-item-btn {
            padding: 3px 6px;
            font-size: 0.7rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .rename-btn {
            background: #f39c12;
            color: white;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .empty-state {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 0.85rem;
        }

        /* Code Editor */
        .code-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .code-header h3 {
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .current-file-name {
            font-size: 0.8rem;
            color: #3498db;
            font-weight: 600;
        }

        .code-input {
            flex: 1;
            background: #2c3e50;
            border: 1px solid #34495e;
            border-radius: 6px;
            padding: 12px;
            color: #ecf0f1;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
            resize: none;
            line-height: 1.5;
        }

        .code-input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Layout Controls */
        .layout-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .layout-section h3 {
            font-size: 0.9rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .slider-label {
            font-size: 0.8rem;
            color: #666;
            min-width: 120px;
        }

        .slider-input {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
        }

        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }

        .slider-value {
            font-size: 0.8rem;
            color: #333;
            min-width: 40px;
            text-align: right;
        }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .parse-btn {
            flex: 1;
            padding: 12px 16px;
            background: #27ae60;
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .parse-btn:hover {
            background: #219a52;
        }

        .load-example-btn {
            padding: 12px 16px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.2s;
        }

        .load-example-btn:hover {
            background: #d5dbdb;
            color: #2c3e50;
        }

        /* Right Panel - Visualization */
        .viz-panel {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #fff;
            background-image: 
                linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .viz-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .viz-controls button {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            color: #666;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .viz-controls button:hover {
            background: #f8f9fa;
            border-color: #3498db;
            color: #3498db;
        }

        #visualization {
            width: 100%;
            height: 100%;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(255,255,255,0.95);
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .legend h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 0.75rem;
            color: #666;
        }

        .legend-shape {
            width: 20px;
            height: 14px;
            border-radius: 2px;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(44, 62, 80, 0.95);
            border-radius: 6px;
            padding: 10px 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 320px;
            z-index: 1000;
            color: #ecf0f1;
        }

        .tooltip h4 {
            color: #3498db;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .tooltip p {
            font-size: 0.8rem;
            margin: 2px 0;
        }

        .tooltip code {
            background: rgba(0,0,0,0.3);
            padding: 1px 5px;
            border-radius: 3px;
            font-family: 'Fira Code', monospace;
            font-size: 0.75rem;
        }

        .tooltip .body-list {
            margin-top: 5px;
            padding-left: 10px;
            border-left: 2px solid #3498db;
            font-family: 'Fira Code', monospace;
            font-size: 0.7rem;
            max-height: 150px;
            overflow-y: auto;
        }

        .tooltip .body-list div {
            padding: 2px 0;
            color: #a8dadc;
        }

        .loop-detail-text {
            font-family: 'Fira Code', monospace;
            font-size: 9px;
            fill: #666;
        }

        /* Modal for rename */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            min-width: 300px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }

        .modal h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .modal input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .modal input:focus {
            outline: none;
            border-color: #3498db;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .modal-btn.cancel {
            background: #ecf0f1;
            color: #666;
        }

        .modal-btn.confirm {
            background: #3498db;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-panel">
            <h2>üêç Python Structure Visualizer</h2>
            
            <div class="project-name-row">
                <input type="text" class="project-name-input" id="projectName" placeholder="Project Name" value="My Project">
            </div>
            
            <!-- File Management Section -->
            <div class="file-section">
                <div class="file-section-header">
                    <h3>üìÅ Files</h3>
                    <div class="file-actions">
                        <input type="file" id="fileUploadInput" accept=".py" multiple>
                        <button class="file-action-btn upload-btn" id="uploadBtn">üì§ Upload</button>
                        <button class="file-action-btn new-file-btn" id="newFileBtn">+ New</button>
                        <button class="file-action-btn clear-btn" id="clearAllBtn">üóë Clear</button>
                    </div>
                </div>
                <div class="file-list" id="fileList">
                    <div class="empty-state">No files yet. Upload or create a new file.</div>
                </div>
            </div>

            <!-- Code Editor Section -->
            <div class="code-section">
                <div class="code-header">
                    <h3>üìù Code Editor</h3>
                    <span class="current-file-name" id="currentFileName">No file selected</span>
                </div>
                <textarea class="code-input" id="codeInput" placeholder="Select or create a file to start coding..." disabled></textarea>
            </div>

            <!-- Layout Controls -->
            <div class="layout-section">
                <h3>‚öôÔ∏è Layout Settings</h3>
                <div class="slider-row">
                    <span class="slider-label">Horizontal Spacing:</span>
                    <input type="range" class="slider-input" id="horizontalSpacing" min="150" max="400" value="280">
                    <span class="slider-value" id="horizontalSpacingValue">280px</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label">Vertical Spacing:</span>
                    <input type="range" class="slider-input" id="verticalSpacing" min="10" max="50" value="20">
                    <span class="slider-value" id="verticalSpacingValue">20px</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label">Method Offset:</span>
                    <input type="range" class="slider-input" id="methodOffset" min="50" max="200" value="100">
                    <span class="slider-value" id="methodOffsetValue">100px</span>
                </div>
            </div>

            <div class="btn-row">
                <button class="parse-btn" id="parseBtn">‚ñ∂ Generate Diagram</button>
                <button class="load-example-btn" id="loadExampleBtn">Load Example</button>
            </div>
        </div>
        
        <div class="viz-panel">
            <div class="viz-controls">
                <button id="zoomIn">+</button>
                <button id="zoomOut">‚àí</button>
                <button id="resetView">Reset</button>
                <button id="exportSVG">Export SVG</button>
            </div>
            
            <svg id="visualization"></svg>
            
            <div class="legend">
                <h4>Legend</h4>
                <div class="legend-item">
                    <div class="legend-shape" style="background: #dae8fc; border: 1px solid #6c8ebf;"></div>
                    <span>Project</span>
                </div>
                <div class="legend-item">
                    <div class="legend-shape" style="background: #fff2cc; border: 1px solid #d6b656;"></div>
                    <span>Module</span>
                </div>
                <div class="legend-item">
                    <div class="legend-shape" style="background: #d5e8d4; border: 1px solid #82b366; border-radius: 50%;"></div>
                    <span>Class</span>
                </div>
                <div class="legend-item">
                    <div class="legend-shape" style="background: #f8cecc; border: 1px solid #b85450;"></div>
                    <span>Method / Function</span>
                </div>
                <div class="legend-item">
                    <div class="legend-shape" style="background: #e1d5e7; border: 1px solid #9673a6;"></div>
                    <span>Variable</span>
                </div>
                <div class="legend-item">
                    <div class="legend-shape" style="background: #f5f5f5; border: 1px solid #666;"></div>
                    <span>Data / List</span>
                </div>
                <div class="legend-item">
                    <div class="legend-shape" style="background: #fff2cc; border: 1px solid #d6b656;"></div>
                    <span>Loop (For/While)</span>
                </div>
            </div>
            
            <div class="tooltip" id="tooltip"></div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal">
            <h3>Rename File</h3>
            <input type="text" id="renameInput" placeholder="Enter new filename">
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="renameCancelBtn">Cancel</button>
                <button class="modal-btn confirm" id="renameConfirmBtn">Rename</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // Configuration (with adjustable values)
        // =============================================
        const CONFIG = {
            project: { w: 160, h: 45 },
            module: { w: 140, h: 35 },
            class: { w: 140, h: 45 },
            method: { w: 130, h: 35, gapY: 15 },
            variable: { w: 120, h: 24, offsetX: 90, gapY: 8 },
            data: { w: 110, h: 40, gapY: 15 },
            loop: { w: 160, h: 50, gapY: 15 },
            loopBody: { w: 140, h: 22, offsetX: 40, gapY: 6 },
            instantiation: { w: 180, h: 30, gapY: 15 },
            moduleStartY: 120,
            // Adjustable via sliders
            horizontalSpacing: 280,
            verticalGap: 20,
            methodOffsetX: 100,
            colors: {
                project: { fill: '#dae8fc', stroke: '#6c8ebf' },
                module: { fill: '#fff2cc', stroke: '#d6b656' },
                class: { fill: '#d5e8d4', stroke: '#82b366' },
                method: { fill: '#f8cecc', stroke: '#b85450' },
                variable: { fill: '#e1d5e7', stroke: '#9673a6' },
                data: { fill: '#f5f5f5', stroke: '#666666' },
                loop: { fill: '#fff2cc', stroke: '#d6b656' },
                loopBody: { fill: '#fef9e7', stroke: '#d4ac0d' },
                instantiation: { fill: '#fff2cc', stroke: '#d6b656' },
                link: '#666'
            }
        };

        // =============================================
        // File Management
        // =============================================
        let files = [];
        let activeFileIndex = -1;
        let renameTargetIndex = -1;

        const fileList = document.getElementById('fileList');
        const codeInput = document.getElementById('codeInput');
        const currentFileName = document.getElementById('currentFileName');
        const fileUploadInput = document.getElementById('fileUploadInput');
        const renameModal = document.getElementById('renameModal');
        const renameInput = document.getElementById('renameInput');

        function renderFileList() {
            if (files.length === 0) {
                fileList.innerHTML = '<div class="empty-state">No files yet. Upload or create a new file.</div>';
                codeInput.disabled = true;
                codeInput.value = '';
                currentFileName.textContent = 'No file selected';
                return;
            }

            fileList.innerHTML = '';
            files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = `file-item ${index === activeFileIndex ? 'active' : ''}`;
                item.innerHTML = `
                    <span class="file-item-name">üìÑ ${file.name}</span>
                    <div class="file-item-actions">
                        <button class="file-item-btn rename-btn" data-index="${index}">‚úèÔ∏è</button>
                        <button class="file-item-btn delete-btn" data-index="${index}">üóë</button>
                    </div>
                `;
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('file-item-btn')) {
                        selectFile(index);
                    }
                });
                fileList.appendChild(item);
            });

            // Update code input state
            if (activeFileIndex >= 0 && activeFileIndex < files.length) {
                codeInput.disabled = false;
                currentFileName.textContent = files[activeFileIndex].name;
            }
        }

        function selectFile(index) {
            // Save current file code
            if (activeFileIndex >= 0 && activeFileIndex < files.length) {
                files[activeFileIndex].code = codeInput.value;
            }
            
            activeFileIndex = index;
            codeInput.value = files[index].code;
            codeInput.disabled = false;
            currentFileName.textContent = files[index].name;
            renderFileList();
        }

        function addFile(name, code = '') {
            // Ensure unique name
            let uniqueName = name;
            let counter = 1;
            while (files.some(f => f.name === uniqueName)) {
                const baseName = name.replace('.py', '');
                uniqueName = `${baseName}_${counter}.py`;
                counter++;
            }
            
            files.push({ name: uniqueName, code: code });
            selectFile(files.length - 1);
        }

        function deleteFile(index) {
            files.splice(index, 1);
            if (files.length === 0) {
                activeFileIndex = -1;
            } else if (activeFileIndex >= files.length) {
                activeFileIndex = files.length - 1;
            } else if (activeFileIndex === index) {
                activeFileIndex = Math.max(0, index - 1);
            }
            
            if (activeFileIndex >= 0) {
                codeInput.value = files[activeFileIndex].code;
            }
            renderFileList();
        }

        function renameFile(index, newName) {
            if (!newName.endsWith('.py')) {
                newName += '.py';
            }
            
            // Check for duplicates
            if (files.some((f, i) => f.name === newName && i !== index)) {
                alert('A file with this name already exists!');
                return false;
            }
            
            files[index].name = newName;
            renderFileList();
            return true;
        }

        // Upload button
        document.getElementById('uploadBtn').addEventListener('click', () => {
            fileUploadInput.click();
        });

        // File upload handler
        fileUploadInput.addEventListener('change', (e) => {
            const uploadedFiles = Array.from(e.target.files);
            
            uploadedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    addFile(file.name, event.target.result);
                };
                reader.readAsText(file);
            });
            
            // Reset input
            fileUploadInput.value = '';
        });

        // New file button
        document.getElementById('newFileBtn').addEventListener('click', () => {
            const name = prompt('Enter file name:', 'new_file.py');
            if (name) {
                addFile(name.endsWith('.py') ? name : name + '.py');
            }
        });

        // Clear all button
        document.getElementById('clearAllBtn').addEventListener('click', () => {
            if (files.length === 0) return;
            
            if (confirm('Clear all files? This cannot be undone.')) {
                files = [];
                activeFileIndex = -1;
                codeInput.value = '';
                codeInput.disabled = true;
                currentFileName.textContent = 'No file selected';
                document.getElementById('projectName').value = 'My Project';
                renderFileList();
                initVisualization();
            }
        });

        // File list click handlers (rename/delete)
        fileList.addEventListener('click', (e) => {
            if (e.target.classList.contains('rename-btn')) {
                renameTargetIndex = parseInt(e.target.dataset.index);
                renameInput.value = files[renameTargetIndex].name;
                renameModal.classList.add('show');
                renameInput.focus();
                renameInput.select();
            } else if (e.target.classList.contains('delete-btn')) {
                const index = parseInt(e.target.dataset.index);
                if (confirm(`Delete "${files[index].name}"?`)) {
                    deleteFile(index);
                }
            }
        });

        // Rename modal handlers
        document.getElementById('renameCancelBtn').addEventListener('click', () => {
            renameModal.classList.remove('show');
            renameTargetIndex = -1;
        });

        document.getElementById('renameConfirmBtn').addEventListener('click', () => {
            if (renameTargetIndex >= 0) {
                renameFile(renameTargetIndex, renameInput.value);
            }
            renameModal.classList.remove('show');
            renameTargetIndex = -1;
        });

        renameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('renameConfirmBtn').click();
            } else if (e.key === 'Escape') {
                document.getElementById('renameCancelBtn').click();
            }
        });

        // Save code on input
        codeInput.addEventListener('input', () => {
            if (activeFileIndex >= 0 && activeFileIndex < files.length) {
                files[activeFileIndex].code = codeInput.value;
            }
        });

        // =============================================
        // Layout Sliders
        // =============================================
        const horizontalSlider = document.getElementById('horizontalSpacing');
        const verticalSlider = document.getElementById('verticalSpacing');
        const methodOffsetSlider = document.getElementById('methodOffset');

        horizontalSlider.addEventListener('input', (e) => {
            CONFIG.horizontalSpacing = parseInt(e.target.value);
            document.getElementById('horizontalSpacingValue').textContent = e.target.value + 'px';
        });

        verticalSlider.addEventListener('input', (e) => {
            CONFIG.verticalGap = parseInt(e.target.value);
            document.getElementById('verticalSpacingValue').textContent = e.target.value + 'px';
        });

        methodOffsetSlider.addEventListener('input', (e) => {
            CONFIG.methodOffsetX = parseInt(e.target.value);
            document.getElementById('methodOffsetValue').textContent = e.target.value + 'px';
        });

        // =============================================
        // Python Parser
        // =============================================
        function parsePythonCode(code, moduleName) {
            const result = {
                name: moduleName,
                elements: []
            };

            const lines = code.split('\n');
            let currentClass = null;
            let currentMethod = null;
            let classIndent = -1;
            let methodIndent = -1;
            let i = 0;

            while (i < lines.length) {
                const line = lines[i];
                const trimmed = line.trim();
                const indent = line.search(/\S/);
                
                if (indent === -1 || trimmed.startsWith('#')) {
                    i++;
                    continue;
                }

                if (currentClass && indent <= classIndent && trimmed) {
                    currentClass = null;
                    currentMethod = null;
                    classIndent = -1;
                    methodIndent = -1;
                }

                if (currentMethod && indent <= methodIndent && !trimmed.startsWith('def ')) {
                    currentMethod = null;
                    methodIndent = -1;
                }

                if (trimmed.startsWith('import ') || trimmed.startsWith('from ')) {
                    i++;
                    continue;
                }

                const classMatch = trimmed.match(/^class\s+(\w+)(?:\(.*\))?:/);
                if (classMatch) {
                    currentClass = {
                        type: 'class',
                        name: classMatch[1],
                        methods: []
                    };
                    result.elements.push(currentClass);
                    classIndent = indent;
                    currentMethod = null;
                    methodIndent = -1;
                    i++;
                    continue;
                }

                if (currentClass) {
                    const methodMatch = trimmed.match(/^def\s+(\w+)\s*\(/);
                    if (methodMatch) {
                        currentMethod = {
                            type: 'method',
                            name: methodMatch[1],
                            variables: []
                        };
                        currentClass.methods.push(currentMethod);
                        methodIndent = indent;
                        i++;
                        continue;
                    }

                    if (currentMethod) {
                        const selfMatch = trimmed.match(/self\.(\w+)\s*=/);
                        if (selfMatch) {
                            const varName = `self.${selfMatch[1]}`;
                            if (!currentMethod.variables.includes(varName)) {
                                currentMethod.variables.push(varName);
                            }
                            i++;
                            continue;
                        }

                        const varMatch = trimmed.match(/^(\w+)\s*=\s*(?!.*def\s)/);
                        if (varMatch && !['self', '_', 'True', 'False', 'None'].includes(varMatch[1])) {
                            if (!currentMethod.variables.includes(varMatch[1])) {
                                currentMethod.variables.push(varMatch[1]);
                            }
                        }
                    }
                    i++;
                    continue;
                }

                const dictMatch = trimmed.match(/^(\w+)\s*=\s*[\[{]/);
                if (dictMatch) {
                    result.elements.push({
                        type: 'data',
                        name: dictMatch[1],
                        isDict: trimmed.includes('{')
                    });
                    i++;
                    continue;
                }

                const simpleVarMatch = trimmed.match(/^(\w+)\s*=\s*(.+)$/);
                if (simpleVarMatch && !trimmed.includes('(') && !currentClass) {
                    const varName = simpleVarMatch[1];
                    const varValue = simpleVarMatch[2].trim();
                    if (!['True', 'False', 'None'].includes(varName)) {
                        result.elements.push({
                            type: 'variable',
                            name: varName,
                            value: varValue
                        });
                        i++;
                        continue;
                    }
                }

                if (trimmed.startsWith('for ') && !currentClass) {
                    const forMatch = trimmed.match(/^for\s+(\w+)\s+in\s+(.+):/);
                    if (forMatch) {
                        const loopIndent = indent;
                        const bodyStatements = [];
                        
                        let j = i + 1;
                        while (j < lines.length) {
                            const bodyLine = lines[j];
                            const bodyTrimmed = bodyLine.trim();
                            const bodyIndent = bodyLine.search(/\S/);
                            
                            if (bodyIndent === -1) {
                                j++;
                                continue;
                            }
                            
                            if (bodyIndent <= loopIndent) break;
                            
                            if (!bodyTrimmed.startsWith('#')) {
                                bodyStatements.push(bodyTrimmed);
                            }
                            j++;
                        }
                        
                        result.elements.push({
                            type: 'forLoop',
                            iterator: forMatch[1],
                            iterable: forMatch[2],
                            body: bodyStatements,
                            fullCondition: `${forMatch[1]} in ${forMatch[2]}`
                        });
                        
                        i = j;
                        continue;
                    }
                }

                if (trimmed.startsWith('while ') && !currentClass) {
                    const whileMatch = trimmed.match(/^while\s+(.+):/);
                    if (whileMatch) {
                        const loopIndent = indent;
                        const bodyStatements = [];
                        
                        let j = i + 1;
                        while (j < lines.length) {
                            const bodyLine = lines[j];
                            const bodyTrimmed = bodyLine.trim();
                            const bodyIndent = bodyLine.search(/\S/);
                            
                            if (bodyIndent === -1) {
                                j++;
                                continue;
                            }
                            
                            if (bodyIndent <= loopIndent) break;
                            
                            if (!bodyTrimmed.startsWith('#')) {
                                bodyStatements.push(bodyTrimmed);
                            }
                            j++;
                        }
                        
                        result.elements.push({
                            type: 'whileLoop',
                            condition: whileMatch[1],
                            body: bodyStatements
                        });
                        
                        i = j;
                        continue;
                    }
                }

                const instMatch = trimmed.match(/^(\w+)\s*=\s*(\w+)\s*\((.*)?\)/);
                if (instMatch && !currentClass) {
                    const className = instMatch[2];
                    if (className[0] === className[0].toUpperCase() && className[0] !== className[0].toLowerCase()) {
                        result.elements.push({
                            type: 'instantiation',
                            variable: instMatch[1],
                            className: className,
                            args: instMatch[3] || ''
                        });
                        i++;
                        continue;
                    }
                }

                const funcMatch = trimmed.match(/^def\s+(\w+)\s*\((.*)?\):/);
                if (funcMatch && !currentClass) {
                    const funcIndent = indent;
                    const funcBody = [];
                    
                    let j = i + 1;
                    while (j < lines.length) {
                        const bodyLine = lines[j];
                        const bodyTrimmed = bodyLine.trim();
                        const bodyIndent = bodyLine.search(/\S/);
                        
                        if (bodyIndent === -1) {
                            j++;
                            continue;
                        }
                        
                        if (bodyIndent <= funcIndent) break;
                        
                        if (!bodyTrimmed.startsWith('#')) {
                            const localVar = bodyTrimmed.match(/^(\w+)\s*=\s*/);
                            if (localVar && !['return', 'if', 'else', 'elif', 'for', 'while'].includes(localVar[1])) {
                                funcBody.push(localVar[1]);
                            }
                        }
                        j++;
                    }
                    
                    result.elements.push({
                        type: 'function',
                        name: funcMatch[1],
                        params: funcMatch[2] || '',
                        variables: funcBody
                    });
                    
                    i = j;
                    continue;
                }

                i++;
            }

            return result;
        }

        // =============================================
        // D3 Visualization
        // =============================================
        const svg = d3.select('#visualization');
        const tooltip = d3.select('#tooltip');
        let g;
        let zoom;

        function initVisualization() {
            const width = svg.node().parentElement.clientWidth;
            const height = svg.node().parentElement.clientHeight;

            svg.attr('width', width).attr('height', height);
            svg.selectAll('*').remove();

            const defs = svg.append('defs');
            
            defs.append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 8)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 5)
                .attr('markerHeight', 5)
                .append('path')
                .attr('d', 'M 0,-3 Q 5,0 0,3 L 8,0 Z')
                .attr('fill', CONFIG.colors.link);

            g = svg.append('g');

            zoom = d3.zoom()
                .scaleExtent([0.2, 3])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);
        }

        function createRoundedPath(x1, y1, x2, y2, type) {
            const radius = 10;
            
            if (type === 'centered') {
                if (Math.abs(x1 - x2) < 5) {
                    return `M ${x1} ${y1} L ${x1} ${y2}`;
                } else {
                    const midY = (y1 + y2) / 2;
                    const dir = x2 > x1 ? 1 : -1;
                    
                    return `M ${x1} ${y1} 
                            L ${x1} ${midY - radius}
                            Q ${x1} ${midY} ${x1 + dir * radius} ${midY}
                            L ${x2 - dir * radius} ${midY}
                            Q ${x2} ${midY} ${x2} ${midY + radius}
                            L ${x2} ${y2}`;
                }
            } else {
                const dropY = y1 + 15;
                const approachX = x2 - 20;
                
                return `M ${x1} ${y1}
                        L ${x1} ${dropY - radius}
                        Q ${x1} ${dropY} ${x1 + radius} ${dropY}
                        L ${approachX - radius} ${dropY}
                        Q ${approachX} ${dropY} ${approachX} ${dropY + radius}
                        L ${approachX} ${y2 - radius}
                        Q ${approachX} ${y2} ${approachX + radius} ${y2}
                        L ${x2} ${y2}`;
            }
        }

        function renderSequentialFlow(projectName, modules) {
            initVisualization();

            const width = svg.node().parentElement.clientWidth;
            const nodes = [];
            const links = [];

            // Calculate column widths using CONFIG values
            const columnWidths = [];
            modules.forEach((mod) => {
                let maxWidth = CONFIG.module.w;
                mod.elements.forEach(el => {
                    if (el.type === 'class') {
                        const varWidth = CONFIG.methodOffsetX + CONFIG.variable.offsetX + CONFIG.variable.w;
                        maxWidth = Math.max(maxWidth, varWidth + 40);
                    }
                    if (el.type === 'forLoop' || el.type === 'whileLoop') {
                        const loopWidth = CONFIG.methodOffsetX + CONFIG.loop.w + CONFIG.loopBody.offsetX + CONFIG.loopBody.w;
                        maxWidth = Math.max(maxWidth, loopWidth + 20);
                    }
                    if (el.type === 'instantiation') {
                        maxWidth = Math.max(maxWidth, CONFIG.instantiation.w + 20);
                    }
                });
                columnWidths.push(maxWidth);
            });

            const columnX = [];
            let currentX = 60;
            columnWidths.forEach((w, i) => {
                columnX.push(currentX);
                currentX += Math.max(w, CONFIG.horizontalSpacing);
            });
            const totalWidth = currentX;

            // Project node
            const projectNode = {
                id: 'project',
                type: 'project',
                name: projectName,
                x: 60 + (totalWidth - 60) / 2 - CONFIG.project.w / 2,
                y: 30,
                w: CONFIG.project.w,
                h: CONFIG.project.h
            };
            nodes.push(projectNode);

            // Process modules
            modules.forEach((mod, modIdx) => {
                const modX = columnX[modIdx];
                let curY = CONFIG.moduleStartY;

                const moduleNode = {
                    id: `mod_${modIdx}`,
                    type: 'module',
                    name: mod.name.replace('.py', ''),
                    x: modX,
                    y: curY,
                    w: CONFIG.module.w,
                    h: CONFIG.module.h
                };
                nodes.push(moduleNode);
                links.push({ source: projectNode.id, target: moduleNode.id, type: 'centered' });

                curY += CONFIG.module.h + CONFIG.verticalGap;
                let lastCenteredNode = moduleNode;

                mod.elements.forEach((el, elIdx) => {
                    if (el.type === 'data') {
                        const dataNode = {
                            id: `mod_${modIdx}_data_${elIdx}`,
                            type: 'data',
                            name: el.name,
                            x: modX + (CONFIG.module.w - CONFIG.data.w) / 2,
                            y: curY,
                            w: CONFIG.data.w,
                            h: CONFIG.data.h,
                            isDict: el.isDict
                        };
                        nodes.push(dataNode);
                        links.push({ source: lastCenteredNode.id, target: dataNode.id, type: 'centered' });
                        lastCenteredNode = dataNode;
                        curY += CONFIG.data.h + CONFIG.data.gapY;
                    }
                    else if (el.type === 'variable') {
                        const varNode = {
                            id: `mod_${modIdx}_var_${elIdx}`,
                            type: 'variable',
                            name: `${el.name} = ${el.value}`,
                            x: modX + (CONFIG.module.w - CONFIG.variable.w - 20) / 2,
                            y: curY,
                            w: CONFIG.variable.w + 20,
                            h: CONFIG.variable.h
                        };
                        nodes.push(varNode);
                        links.push({ source: lastCenteredNode.id, target: varNode.id, type: 'centered' });
                        lastCenteredNode = varNode;
                        curY += CONFIG.variable.h + CONFIG.variable.gapY + 5;
                    }
                    else if (el.type === 'class') {
                        const classNode = {
                            id: `mod_${modIdx}_class_${elIdx}`,
                            type: 'class',
                            name: el.name,
                            x: modX + (CONFIG.module.w - CONFIG.class.w) / 2,
                            y: curY,
                            w: CONFIG.class.w,
                            h: CONFIG.class.h
                        };
                        nodes.push(classNode);
                        links.push({ source: lastCenteredNode.id, target: classNode.id, type: 'centered' });

                        let methodY = curY + CONFIG.class.h + CONFIG.method.gapY;
                        const methodX = modX + CONFIG.methodOffsetX;

                        el.methods.forEach((method, mIdx) => {
                            const methodNode = {
                                id: `mod_${modIdx}_class_${elIdx}_method_${mIdx}`,
                                type: 'method',
                                name: method.name,
                                x: methodX,
                                y: methodY,
                                w: CONFIG.method.w,
                                h: CONFIG.method.h
                            };
                            nodes.push(methodNode);
                            links.push({ source: classNode.id, target: methodNode.id, type: 'offset' });

                            let varY = methodY + CONFIG.method.h + CONFIG.variable.gapY;
                            const varX = methodX + CONFIG.variable.offsetX;

                            method.variables.forEach((varName, vIdx) => {
                                const varNode = {
                                    id: `mod_${modIdx}_class_${elIdx}_method_${mIdx}_var_${vIdx}`,
                                    type: 'variable',
                                    name: varName,
                                    x: varX,
                                    y: varY,
                                    w: CONFIG.variable.w,
                                    h: CONFIG.variable.h
                                };
                                nodes.push(varNode);
                                links.push({ source: methodNode.id, target: varNode.id, type: 'offset' });
                                varY += CONFIG.variable.h + CONFIG.variable.gapY;
                            });

                            methodY = method.variables.length > 0 ? varY + CONFIG.method.gapY : methodY + CONFIG.method.h + CONFIG.method.gapY + 20;
                        });

                        curY = methodY + 10;
                        lastCenteredNode = classNode;
                    }
                    else if (el.type === 'function') {
                        const funcNode = {
                            id: `mod_${modIdx}_func_${elIdx}`,
                            type: 'method',
                            name: el.name,
                            params: el.params,
                            x: modX + (CONFIG.module.w - CONFIG.method.w) / 2,
                            y: curY,
                            w: CONFIG.method.w,
                            h: CONFIG.method.h
                        };
                        nodes.push(funcNode);
                        links.push({ source: lastCenteredNode.id, target: funcNode.id, type: 'centered' });
                        
                        let varY = curY + CONFIG.method.h + CONFIG.variable.gapY;
                        const varX = modX + CONFIG.method.w + 20;
                        
                        el.variables.forEach((varName, vIdx) => {
                            const varNode = {
                                id: `mod_${modIdx}_func_${elIdx}_var_${vIdx}`,
                                type: 'variable',
                                name: varName,
                                x: varX,
                                y: varY,
                                w: CONFIG.variable.w,
                                h: CONFIG.variable.h
                            };
                            nodes.push(varNode);
                            links.push({ source: funcNode.id, target: varNode.id, type: 'offset' });
                            varY += CONFIG.variable.h + CONFIG.variable.gapY;
                        });
                        
                        lastCenteredNode = funcNode;
                        curY = el.variables.length > 0 ? varY + CONFIG.method.gapY : curY + CONFIG.method.h + CONFIG.method.gapY;
                    }
                    else if (el.type === 'forLoop') {
                        const loopNode = {
                            id: `mod_${modIdx}_forloop_${elIdx}`,
                            type: 'forLoop',
                            name: 'For',
                            iterator: el.iterator,
                            iterable: el.iterable,
                            body: el.body,
                            fullCondition: el.fullCondition,
                            x: modX + CONFIG.methodOffsetX,
                            y: curY,
                            w: CONFIG.loop.w,
                            h: CONFIG.loop.h
                        };
                        nodes.push(loopNode);
                        links.push({ source: lastCenteredNode.id, target: loopNode.id, type: 'offset' });

                        let bodyY = curY + CONFIG.loop.h + CONFIG.loopBody.gapY;
                        const bodyX = modX + CONFIG.methodOffsetX + CONFIG.loopBody.offsetX;

                        el.body.slice(0, 5).forEach((stmt, bIdx) => {
                            const bodyNode = {
                                id: `mod_${modIdx}_forloop_${elIdx}_body_${bIdx}`,
                                type: 'loopBody',
                                name: stmt.length > 25 ? stmt.substring(0, 22) + '...' : stmt,
                                fullStatement: stmt,
                                x: bodyX,
                                y: bodyY,
                                w: CONFIG.loopBody.w,
                                h: CONFIG.loopBody.h
                            };
                            nodes.push(bodyNode);
                            links.push({ source: loopNode.id, target: bodyNode.id, type: 'offset' });
                            bodyY += CONFIG.loopBody.h + CONFIG.loopBody.gapY;
                        });

                        curY = bodyY + CONFIG.loop.gapY;
                    }
                    else if (el.type === 'whileLoop') {
                        const loopNode = {
                            id: `mod_${modIdx}_whileloop_${elIdx}`,
                            type: 'whileLoop',
                            name: 'While',
                            condition: el.condition,
                            body: el.body,
                            x: modX + CONFIG.methodOffsetX,
                            y: curY,
                            w: CONFIG.loop.w,
                            h: CONFIG.loop.h
                        };
                        nodes.push(loopNode);
                        links.push({ source: lastCenteredNode.id, target: loopNode.id, type: 'offset' });

                        let bodyY = curY + CONFIG.loop.h + CONFIG.loopBody.gapY;
                        const bodyX = modX + CONFIG.methodOffsetX + CONFIG.loopBody.offsetX;

                        el.body.slice(0, 5).forEach((stmt, bIdx) => {
                            const bodyNode = {
                                id: `mod_${modIdx}_whileloop_${elIdx}_body_${bIdx}`,
                                type: 'loopBody',
                                name: stmt.length > 25 ? stmt.substring(0, 22) + '...' : stmt,
                                fullStatement: stmt,
                                x: bodyX,
                                y: bodyY,
                                w: CONFIG.loopBody.w,
                                h: CONFIG.loopBody.h
                            };
                            nodes.push(bodyNode);
                            links.push({ source: loopNode.id, target: bodyNode.id, type: 'offset' });
                            bodyY += CONFIG.loopBody.h + CONFIG.loopBody.gapY;
                        });

                        curY = bodyY + CONFIG.loop.gapY;
                    }
                    else if (el.type === 'instantiation') {
                        const instText = `${el.variable} = ${el.className}(${el.args})`;
                        const instNode = {
                            id: `mod_${modIdx}_inst_${elIdx}`,
                            type: 'instantiation',
                            name: instText,
                            shortName: el.variable,
                            className: el.className,
                            x: modX + (CONFIG.module.w - CONFIG.instantiation.w) / 2,
                            y: curY,
                            w: CONFIG.instantiation.w,
                            h: CONFIG.instantiation.h
                        };
                        nodes.push(instNode);
                        links.push({ source: lastCenteredNode.id, target: instNode.id, type: 'centered' });
                        lastCenteredNode = instNode;
                        curY += CONFIG.instantiation.h + CONFIG.instantiation.gapY;
                    }
                });
            });

            const nodeMap = {};
            nodes.forEach(n => nodeMap[n.id] = n);

            // Draw links
            g.selectAll('.link')
                .data(links)
                .enter()
                .append('path')
                .attr('class', 'link')
                .attr('fill', 'none')
                .attr('stroke', CONFIG.colors.link)
                .attr('stroke-width', 1.5)
                .attr('marker-end', 'url(#arrowhead)')
                .attr('d', d => {
                    const source = nodeMap[d.source];
                    const target = nodeMap[d.target];
                    
                    const x1 = source.x + source.w / 2;
                    const y1 = source.y + source.h;
                    const x2 = d.type === 'centered' ? target.x + target.w / 2 : target.x;
                    const y2 = d.type === 'centered' ? target.y : target.y + target.h / 2;
                    
                    return createRoundedPath(x1, y1, x2, y2, d.type);
                });

            // Draw nodes
            const nodeGroups = g.selectAll('.node-group')
                .data(nodes)
                .enter()
                .append('g')
                .attr('class', d => `node-group node-${d.type}`)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);

            nodeGroups.each(function(d) {
                const node = d3.select(this);
                const colors = CONFIG.colors[d.type] || CONFIG.colors.data;

                switch(d.type) {
                    case 'project':
                        node.append('rect')
                            .attr('x', d.x).attr('y', d.y)
                            .attr('width', d.w).attr('height', d.h)
                            .attr('rx', 8)
                            .attr('fill', colors.fill)
                            .attr('stroke', colors.stroke)
                            .attr('stroke-width', 2);
                        node.append('text')
                            .attr('x', d.x + d.w / 2).attr('y', d.y + d.h / 2)
                            .attr('text-anchor', 'middle')
                            .attr('dominant-baseline', 'middle')
                            .attr('font-size', '14px')
                            .attr('font-weight', 'bold')
                            .attr('fill', '#333')
                            .text(d.name);
                        break;

                    case 'module':
                        node.append('rect')
                            .attr('x', d.x).attr('y', d.y)
                            .attr('width', d.w).attr('height', d.h)
                            .attr('rx', 5)
                            .attr('fill', colors.fill)
                            .attr('stroke', colors.stroke)
                            .attr('stroke-width', 2);
                        node.append('text')
                            .attr('x', d.x + d.w / 2).attr('y', d.y + d.h / 2)
                            .attr('text-anchor', 'middle')
                            .attr('dominant-baseline', 'middle')
                            .attr('font-size', '12px')
                            .attr('font-weight', '600')
                            .attr('fill', '#333')
                            .text(d.name);
                        break;

                    case 'class':
                        node.append('ellipse')
                            .attr('cx', d.x + d.w / 2).attr('cy', d.y + d.h / 2)
                            .attr('rx', d.w / 2).attr('ry', d.h / 2)
                            .attr('fill', colors.fill)
                            .attr('stroke', colors.stroke)
                            .attr('stroke-width', 2);
                        node.append('text')
                            .attr('x', d.x + d.w / 2).attr('y', d.y + d.h / 2)
                            .attr('text-anchor', 'middle')
                            .attr('dominant-baseline', 'middle')
                            .attr('font-size', '11px')
                            .html(`<tspan fill="#2980b9">class </tspan><tspan fill="#333">${d.name}</tspan>`);
                        break;

                    case 'method':
                        const hx = d.x, hy = d.y, hw = d.w, hh = d.h;
                        const indent = hw * 0.12;
                        const hexPoints = [
                            [hx + indent, hy],
                            [hx + hw - indent, hy],
                            [hx + hw, hy + hh / 2],
                            [hx + hw - indent, hy + hh],
                            [hx + indent, hy + hh],
                            [hx, hy + hh / 2]
                        ];
                        node.append('polygon')
                            .attr('points', hexPoints.map(p => p.join(',')).join(' '))
                            .attr('fill', colors.fill)
                            .attr('stroke', colors.stroke)
                            .attr('stroke-width', 2);
                        node.append('text')
                            .attr('x', d.x + d.w / 2).attr('y', d.y + d.h / 2)
                            .attr('text-anchor', 'middle')
                            .attr('dominant-baseline', 'middle')
                            .attr('font-size', '10px')
                            .attr('fill', '#333')
                            .text(d.name);
                        break;

                    case 'variable':
                        node.append('rect')
                            .attr('x', d.x).attr('y', d.y)
                            .attr('width', d.w).attr('height', d.h)
                            .attr('rx', 3)
                            .attr('fill', colors.fill)
                            .attr('stroke', colors.stroke)
                            .attr('stroke-width', 1.5);
                        node.append('text')
                            .attr('x', d.x + d.w / 2).attr('y', d.y + d.h / 2)
                            .attr('text-anchor', 'middle')
                            .attr('dominant-baseline', 'middle')
                            .attr('font-size', '9px')
                            .attr('fill', '#333')
                            .text(d.name.length > 18 ? d.name.substring(0, 15) + '...' : d.name);
                        break;

                    case 'data':
                        if (d.isDict) {
                            node.append('rect')
                                .attr('x', d.x).attr('y', d.y + 6)
                                .attr('width', d.w).attr('height', d.h - 6)
                                .attr('rx', 3)
                                .attr('fill', colors.fill)
                                .attr('stroke', colors.stroke)
                                .attr('stroke-width', 1.5);
                            node.append('ellipse')
                                .attr('cx', d.x + d.w / 2).attr('cy', d.y + 8)
                                .attr('rx', d.w / 2).attr('ry', 8)
                                .attr('fill', colors.fill)
                                .attr('stroke', colors.stroke)
                                .attr('stroke-width', 1.5);
                        } else {
                            node.append('rect')
                                .attr('x', d.x).attr('y', d.y)
                                .attr('width', d.w).attr('height', d.h)
                                .attr('rx', 4)
                                .attr('fill', colors.fill)
                                .attr('stroke', colors.stroke)
                                .attr('stroke-width', 1.5);
                        }
                        node.append('text')
                            .attr('x', d.x + d.w / 2).attr('y', d.y + d.h / 2 + 3)
                            .attr('text-anchor', 'middle')
                            .attr('dominant-baseline', 'middle')
                            .attr('font-size', '10px')
                            .attr('fill', '#333')
                            .text(d.name);
                        break;

                    case 'forLoop':
                    case 'whileLoop':
                        const lx = d.x, ly = d.y, lw = d.w, lh = d.h;
                        const skew = 12;
                        const paraPoints = [
                            [lx + skew, ly],
                            [lx + lw, ly],
                            [lx + lw - skew, ly + lh],
                            [lx, ly + lh]
                        ];
                        node.append('polygon')
                            .attr('points', paraPoints.map(p => p.join(',')).join(' '))
                            .attr('fill', colors.fill)
                            .attr('stroke', colors.stroke)
                            .attr('stroke-width', 2);
                        
                        node.append('text')
                            .attr('x', d.x + d.w / 2).attr('y', d.y + 14)
                            .attr('text-anchor', 'middle')
                            .attr('font-size', '11px')
                            .attr('font-weight', 'bold')
                            .attr('fill', '#333')
                            .text(d.name);
                        
                        const detailText = d.type === 'forLoop' 
                            ? `${d.iterator} in ${d.iterable.substring(0, 15)}${d.iterable.length > 15 ? '...' : ''}`
                            : d.condition.substring(0, 18) + (d.condition.length > 18 ? '...' : '');
                        
                        node.append('text')
                            .attr('x', d.x + d.w / 2).attr('y', d.y + 32)
                            .attr('text-anchor', 'middle')
                            .attr('class', 'loop-detail-text')
                            .text(detailText);
                        break;

                    case 'loopBody':
                        node.append('rect')
                            .attr('x', d.x).attr('y', d.y)
                            .attr('width', d.w).attr('height', d.h)
                            .attr('rx', 2)
                            .attr('fill', CONFIG.colors.loopBody.fill)
                            .attr('stroke', CONFIG.colors.loopBody.stroke)
                            .attr('stroke-width', 1)
                            .attr('stroke-dasharray', '3,2');
                        node.append('text')
                            .attr('x', d.x + 5).attr('y', d.y + d.h / 2)
                            .attr('dominant-baseline', 'middle')
                            .attr('font-size', '9px')
                            .attr('font-family', 'Fira Code, monospace')
                            .attr('fill', '#666')
                            .text(d.name);
                        break;

                    case 'instantiation':
                        node.append('rect')
                            .attr('x', d.x).attr('y', d.y)
                            .attr('width', d.w).attr('height', d.h)
                            .attr('rx', 5)
                            .attr('fill', colors.fill)
                            .attr('stroke', colors.stroke)
                            .attr('stroke-width', 2);
                        node.append('text')
                            .attr('x', d.x + d.w / 2).attr('y', d.y + d.h / 2)
                            .attr('text-anchor', 'middle')
                            .attr('dominant-baseline', 'middle')
                            .attr('font-size', '9px')
                            .attr('fill', '#333')
                            .text(d.name.length > 28 ? d.name.substring(0, 25) + '...' : d.name);
                        break;
                }
            });

            const scale = Math.min(width / (totalWidth + 100), 1, 0.9);
            svg.call(zoom.transform, d3.zoomIdentity.translate(20, 10).scale(scale));
        }

        function showTooltip(event, d) {
            let html = `<h4>${d.name}</h4>`;
            html += `<p>Type: <code>${d.type}</code></p>`;
            
            if (d.type === 'forLoop') {
                html += `<p>Iterator: <code>${d.iterator}</code></p>`;
                html += `<p>Iterable: <code>${d.iterable}</code></p>`;
                if (d.body && d.body.length > 0) {
                    html += `<p>Body (${d.body.length} statements):</p>`;
                    html += `<div class="body-list">`;
                    d.body.forEach(stmt => {
                        html += `<div>${stmt}</div>`;
                    });
                    html += `</div>`;
                }
            }
            
            if (d.type === 'whileLoop') {
                html += `<p>Condition: <code>${d.condition}</code></p>`;
                if (d.body && d.body.length > 0) {
                    html += `<p>Body (${d.body.length} statements):</p>`;
                    html += `<div class="body-list">`;
                    d.body.forEach(stmt => {
                        html += `<div>${stmt}</div>`;
                    });
                    html += `</div>`;
                }
            }

            if (d.type === 'loopBody') {
                html = `<h4>Statement</h4>`;
                html += `<p><code>${d.fullStatement}</code></p>`;
            }

            if (d.type === 'instantiation' && d.className) {
                html += `<p>Creates: <code>${d.className}</code></p>`;
            }

            if (d.type === 'method' && d.params !== undefined) {
                html += `<p>Params: <code>${d.params || 'none'}</code></p>`;
            }

            tooltip
                .html(html)
                .style('left', (event.pageX + 15) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .style('opacity', 1);
        }

        function hideTooltip() {
            tooltip.style('opacity', 0);
        }

        // =============================================
        // Controls
        // =============================================
        document.getElementById('zoomIn').addEventListener('click', () => {
            svg.transition().call(zoom.scaleBy, 1.3);
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            svg.transition().call(zoom.scaleBy, 0.7);
        });

        document.getElementById('resetView').addEventListener('click', () => {
            svg.transition().call(zoom.transform, d3.zoomIdentity.translate(20, 10).scale(0.8));
        });

        document.getElementById('exportSVG').addEventListener('click', () => {
            const svgEl = document.getElementById('visualization');
            const svgData = new XMLSerializer().serializeToString(svgEl);
            const blob = new Blob([svgData], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'python_structure.svg';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Parse Button
        document.getElementById('parseBtn').addEventListener('click', () => {
            // Save current file
            if (activeFileIndex >= 0 && activeFileIndex < files.length) {
                files[activeFileIndex].code = codeInput.value;
            }
            
            const projectName = document.getElementById('projectName').value || 'Project';
            const parsedModules = files
                .filter(f => f.code.trim())
                .map(f => parsePythonCode(f.code, f.name));

            if (parsedModules.length === 0) {
                alert('Please add some Python code first!');
                return;
            }

            renderSequentialFlow(projectName, parsedModules);
        });

        // Load Example
        document.getElementById('loadExampleBtn').addEventListener('click', () => {
            files = [
                {
                    name: 'countdown.py',
                    code: `# While loop example
count = 5

while count > 0:
    print(f"Counting down: {count}")
    count = count - 1

print("Blast off!")`
                },
                {
                    name: 'triangle.py',
                    code: `def user_input():
    height = int(input("Enter height of the star triangle:\\n"))
    return height

height = user_input()

blanks = height
stars = 0

for loops in range(height):
    blanks -= 1
    stars += 1
    print(" " * blanks + "*" * stars)`
                }
            ];

            activeFileIndex = 0;
            codeInput.value = files[0].code;
            codeInput.disabled = false;
            document.getElementById('projectName').value = 'Loop Examples';
            renderFileList();
        });

        // Initialize
        renderFileList();
        initVisualization();
    </script>
</body>
</html>
